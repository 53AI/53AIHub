import{ai as u,aj as g,P as m,ak as Y}from"./main-CF3M_8Rw.js";const S=["星期日","星期一","星期二","星期三","星期四","星期五","星期六"],d=({date:t,format:e="YYYY-MM-DD hh:mm:ss",fillZero:s=!0}={date:new Date})=>{t||(t=new Date),typeof t=="string"&&(t=t.replace(/-/gm,"/")),t=new Date(t);const[i,n,a,o,c,r,h]=[`${t.getFullYear()}`,`${t.getMonth()+1}`,`${t.getDate()}`,`${t.getHours()}`,`${t.getMinutes()}`,`${t.getSeconds()}`,t.getDay()];return e.replace("YYYY",i).replace("YY",i.substring(2)).replace("MM",n.length===1&&s?`0${n}`:n).replace("DD",a.length===1&&s?`0${a}`:a).replace("hh",o.length===1&&s?`0${o}`:o).replace("mm",c.length===1&&s?`0${c}`:c).replace("ss",r.length===1&&s?`0${r}`:r).replace("week",S[h]||"")},_={list(){return u.get("/api/conversations").catch(g)},create(t){return u.post("/api/conversations",t).catch(g)},edit(t,e){return u.put(`/api/conversations/${t}`,e).catch(g)},del(t){return u.delete(`/api/conversations/${t}`).catch(g)},messasges(t,e={}){return u.get(`/api/conversations/${t}/messages`,{params:e}).catch(g)}},A=(t={},e="")=>{const s=window.location.href,[i,n]=s.split("#"),a=n?n.split("?"):[""],o=e||a[0],c=a[1]||"",r=new URLSearchParams(c);Object.entries(t).forEach(([f,l])=>{l!=null?r.set(f,String(l)):r.delete(f)});const h=r.toString(),p=o+(h?`?${h}`:"");window.location.hash=p},v="usual_agents",D=(t,e)=>{try{const s=localStorage.getItem(t);return s?JSON.parse(s):e}catch(s){return console.error(`Error reading localStorage key "${t}":`,s),e}},w={CONVERSATION_LIST:"conversation_list"},C=m("conversation-store",{state:()=>({conversations:[],agents:[],usual_agents:D(v,[]),current_agentid:0,current_conversationid:0,base_path:"/chat"}),getters:{currentAgent:t=>t.usual_agents.find(e=>e.agent_id===t.current_agentid)||{name:"",logo:"",agent_id:0,configs:"{}"},currentConversation:t=>t.conversations.find(e=>e.conversation_id===t.current_conversationid)||{conversation_id:0,title:"",create_time:0,update_time:0,top:0,is_valid:0,virtual_id:Date.now().toString()}},actions:{setBasePath(t){this.base_path=t||"/chat"},async loadConversations(){const t=async()=>(await _.list()).data.conversations.map(s=>(s.created_at=d({date:s.created_time,format:"YYYY.MM.DD hh:mm"}),s.updated_at=d({date:s.updated_time,format:"YYYY.MM.DD hh:mm"}),s));return this.conversations=await Y.getOrFetch(w.CONVERSATION_LIST,t),this.conversations},saveUsualAgents(){try{localStorage.setItem(v,JSON.stringify(this.usual_agents))}catch(t){console.error("Failed to save usual agents:",t)}},async pushUsualAgent(t){const e=this.usual_agents.findIndex(a=>a.agent_id===t.agent_id),s={...t,is_fixed:e>-1?this.usual_agents[e].is_fixed:!1},i=this.usual_agents.filter(a=>a.is_fixed&&a.agent_id!==t.agent_id),n=this.usual_agents.filter(a=>!a.is_fixed&&a.agent_id!==t.agent_id);s.is_fixed?this.usual_agents=[s,...i,...n]:this.usual_agents=[...i,s,...n],this.saveUsualAgents()},toggleUsualAgentFixed(t){const e=this.usual_agents.find(s=>s.agent_id===t.agent_id);if(e){e.is_fixed=!e.is_fixed;const s=this.usual_agents.filter(n=>n.is_fixed&&n.agent_id!==t.agent_id),i=this.usual_agents.filter(n=>!n.is_fixed&&n.agent_id!==t.agent_id);this.usual_agents=e.is_fixed?[e,...s,...i]:[...s,e,...i],this.saveUsualAgents()}},updateUsualAgents(t){this.usual_agents=this.usual_agents.map(e=>e.agent_id===t.agent_id?{...e,...t}:e),this.saveUsualAgents()},deleteUsualAgent(t){this.usual_agents=this.usual_agents.filter(e=>e.agent_id!==t.agent_id),this.saveUsualAgents()},createConversation(t,e=""){return _.create({agent_id:t,title:e}).then(s=>s.data)},addConversation(t){t.created_at=d({date:t.created_time,format:"YYYY.MM.DD hh:mm"}),t.updated_at=d({date:t.updated_time,format:"YYYY.MM.DD hh:mm"}),this.conversations.unshift(t)},updateConversation(t){this.conversations=this.conversations.map(e=>e.conversation_id===t.conversation_id?{...e,...t}:e)},async editConversation(t){const e={title:t.title};await _.edit(t.conversation_id,e),this.updateConversation(t)},async delConversation(t){this.conversations=this.conversations.filter(e=>e.conversation_id!==t.conversation_id),await _.del(t.conversation_id),this.current_conversationid===t.conversation_id&&this.setCurrentState(this.current_agentid,0)},updateAgents(t){this.agents=t,this.usual_agents=this.usual_agents.filter(e=>t.some(s=>s.agent_id===e.agent_id)),this.saveUsualAgents()},setCurrentState(t,e){var s;t&&(this.agents.find(n=>n.agent_id==t)||(t=((s=this.agents[0])==null?void 0:s.agent_id)||0)),e&&(this.conversations.find(n=>n.conversation_id===e)||(e=0)),this.current_agentid=t,this.current_conversationid=e,this.setRouter({agent_id:t||null,conversation_id:e||null})},clearCurrentState(){this.current_agentid=0,this.current_conversationid=0},setRouter(t={}){t.agent_id&&A(t,this.base_path)}}});export{_ as c,C as u};
